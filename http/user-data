#cloud-config
autoinstall:
  version: 1
  locale: en_US
  keyboard:
    layout: us
  timezone: UTC

  identity:
    hostname: wazuh-manager
    username: blue
    # Password disabled; SSH key-only.
    password: "*"

  ssh:
    install-server: true
    allow-pw: false
    authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIC5JU9neFzrsWZKMtEJ1lTcWLvhvKqQUd80/Nla7oqT blue-router

  storage:
    layout:
      name: lvm

  packages:
    - qemu-guest-agent
    - curl
    - openssh-server
    - gnupg
    - apt-transport-https
    - ca-certificates
    - lsb-release

  late-commands:
  # Set root authorized_keys
  - curtin in-target -- sh -c "install -d -m 700 /root/.ssh > /dev/null 2>&1 || true"
  - curtin in-target -- sh -c "printf '%s\n' 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIC5JU9neFzrsWZKMtEJ1lTcWLvhvKqQUd80/Nla7oqT blue-router' > /root/.ssh/authorized_keys"
  - curtin in-target -- sh -c "chmod 600 /root/.ssh/authorized_keys > /dev/null 2>&1 || true"

  # Allow root SSH (key-only)
  - curtin in-target -- sh -c "sed -i 's/^#\\?PermitRootLogin.*/PermitRootLogin prohibit-password/' /etc/ssh/sshd_config > /dev/null 2>&1 || true"
  - curtin in-target -- sh -c "systemctl restart ssh > /dev/null 2>&1 || true"