#cloud-config
autoinstall:
  version: 1
  locale: en_US
  keyboard:
    layout: us
  timezone: UTC
  identity:
    hostname: wazuh-manager
    username: blue
    # Password is disabled; SSH key-only.
    password: "*"
  ssh:
    install-server: true
    allow-pw: false
    authorized-keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIC5JU9neFzrsWZKMtEJ1lTcWLvhvKqQUd80/Nla7oqT blue-router
  storage:
    layout:
      name: lvm
  packages:
    - qemu-guest-agent
    - curl
    - gnupg
    - apt-transport-https
  late-commands:
    # Enable qemu-guest-agent without blocking autoinstall
    - curtin in-target -- systemctl enable qemu-guest-agent >/dev/null 2>&1 || true
    - curtin in-target -- systemctl start qemu-guest-agent >/dev/null 2>&1 || true
    # Hardening SSH: key-only
    - curtin in-target -- sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config >/dev/null 2>&1 || true
    - curtin in-target -- sed -i 's/^#\?KbdInteractiveAuthentication.*/KbdInteractiveAuthentication no/' /etc/ssh/sshd_config >/dev/null 2>&1 || true
    - curtin in-target -- sed -i 's/^#\?ChallengeResponseAuthentication.*/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config >/dev/null 2>&1 || true
    - curtin in-target -- systemctl restart ssh >/dev/null 2>&1 || true
